<!DOCTYPE html>
<html lang="en">

<head>
	<title>LiventCord</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<link rel="stylesheet" type="text/css" href="/static/css/main.css">


</head>

<body>


	<div class="limiter">
		<div class="container-login100"
			style="background-image: url('/static/images/nierforest.jpg'); background-size: cover;">

			<div class="wrap-login100">
				<form id="register-form" class="login100-form validate-form">
					<span class="login100-form-title p-b-26">
						Bir hesap oluştur
					</span>


					<div class="wrap-input100 validate-input" data-validate="Doğru e posta formatı: a@b.c">
						<input class="input100" type="text" name="email">
						<span class="focus-input100" data-placeholder="E posta"></span>
					</div>


					<div class="wrap-input100 validate-input" style="width:80%;" data-validate="Kullanıcı adı">
						<input class="input100" type="text" name="nick">
						<span class="focus-input100" data-placeholder="Kullanıcı adı">
							<p id="discriminatorText"></p>
						</span>
					</div>

					<div class="wrap-input100 validate-input" data-validate="Şifre">
						<span class="btn-show-pass">
							<i class="zmdi zmdi-eye"></i>
						</span>
						<input class="input100" type="password" name="pass">
						<span class="focus-input100" data-placeholder="Şifre"></span>
					</div>

					<div class="container-login100-form-btn">
						<div class="wrap-login100-form-btn">
							<div class="login100-form-bgbtn"></div>
							<button class="login100-form-btn" id="register-btn" onclick="submitForm(event)">
								Kaydol
							</button>
						</div>
					</div>
	
					<div class="text-center p-t-115">
						<a class="txt1" href="/login">
							Zaten bir hesabın var mı?
						</a>
	

					</div>


			</div>
			</form>
		</div>
	</div>
	</div>

	<script>

		function myalert(text, isSuccess = false) {
			const container = document.createElement('div');
			let idtoadd = isSuccess ? 'info-container' : 'error-container';
			container.classList.add(idtoadd);
			container.classList.add('swipe-in');
			setTimeout(() => {
				container.classList.remove('swipe-in');
			}, 3000);

			const childDiv = document.createElement('div');
			childDiv.id = 'info-message';
			childDiv.textContent = text;

			container.appendChild(childDiv);
			document.body.prepend(container);


			setTimeout(() => {
				container.parentNode.removeChild(container);
			}, 5000);
		}





		function submitForm(event) {
			event.preventDefault();

			const lang = translations[currentLanguage];
			const email = document.querySelector('input[name="email"]').value;
			const password = document.querySelector('input[name="pass"]').value;
			const nick = document.querySelector('input[name="nick"]').value;

			if (!validateRegistrationParameters(email, password, nick)) {
				return;
			}

			document.querySelector('input[name="email"]').value = '';
			document.querySelector('input[name="pass"]').value = '';
			document.querySelector('input[name="nick"]').value = '';

			const formData = new FormData();
			formData.append('email', email);
			formData.append('password', password);
			formData.append('nickname', nick);

			fetch('/auth/register', {
				method: 'POST',
				body: formData,
				credentials: 'same-origin'
			})
				.then(response => {
					if (response.status === 200) {
						myalert(lang.success, true);
						setTimeout(() => {
							window.location.href = '/login';
						}, 1500);
					} else if (response.status === 409) {
						myalert(lang.emailExists);
					} else {
						myalert(`${lang.genericError} ${response.status}`);
					}
				})
				.catch(error => {
					console.error('Error:', error);
				});
		}

		function validateRegistrationParameters(email, password, nick) {
			const lang = translations[currentLanguage];
			let isFailed = false;
			let errorMessage = '';

			if (!password || password.length < 5) {
				document.querySelectorAll('.wrap-input100.validate-input')[2].classList.add('alert-validate');
				errorMessage += lang.passPlaceholder;
				isFailed = true;
			}
			if (!nick || nick.length < 1) {
				document.querySelectorAll('.wrap-input100.validate-input')[1].classList.add('alert-validate');
				errorMessage += (isFailed ? ', ' : '') + lang.nickPlaceholder;
				isFailed = true;
			}
			if (!email || email.length < 3 || !validateEmail(email)) {
				document.querySelectorAll('.wrap-input100.validate-input')[0].classList.add('alert-validate');
				errorMessage += (isFailed ? ' and ' : '') + lang.emailPlaceholder;
				isFailed = true;
			}

			if (isFailed) {
				if (password.length < 5) {
					myalert(lang.shortPassword);
				} else {
					myalert(errorMessage + ` ${lang.invalidEmail}`);
				}
				return false;
			}
			return true;
		}

		function validateEmail(email) {
			const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
			return re.test(email);
		}




		var emailInput = document.querySelector('input[name="email"]');
		var nickInput = document.querySelector('input[name="nick"]');
		var passInput = document.querySelector('input[name="pass"]');
		emailInput.addEventListener("keypress", function (event) {
			if (event.key === "Enter") {
				event.preventDefault();
				nickInput.focus();
			}
		});
		let isFetching = false;
		let debounceTimer;
		let currentInputValue = '';

		nickInput.addEventListener("input", async function (event) {
			const newInputValue = nickInput.value.trim();

			if (newInputValue && newInputValue !== currentInputValue && !isFetching) {
				currentInputValue = newInputValue;

				clearTimeout(debounceTimer);
				debounceTimer = setTimeout(async () => {
					try {
						isFetching = true;
						const response = await fetch(`/api/discriminators?nick=${encodeURIComponent(currentInputValue)}`, {
							method: 'GET',
							credentials: 'same-origin'
						});

						if (response.ok) {
							const data = await response.json();
							if (currentInputValue === nickInput.value.trim()) {
								document.getElementById('discriminatorText').textContent = data.result;
							}
						} else {
							throw new Error('Network response was not ok.');
						}
					} catch (error) {
						console.error('Fetch Error:', error);
					} finally {
						isFetching = false;
					}
				}, 500);
			}
		});




		nickInput.addEventListener("keypress", async function (event) {
			if (event.key === "Enter") {
				event.preventDefault();
				passInput.focus();
			}
		});

		passInput.addEventListener("keypress", function (event) {
			if (event.key === "Enter") {
				event.preventDefault();
				submitForm(event);
			}
		});





	</script>

	<div id="dropDownSelect1"></div>



	<body>